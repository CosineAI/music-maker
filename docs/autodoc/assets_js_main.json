{"type":"doc","content":[{"type":"heading","attrs":{"level":1},"content":[{"text":"Transport, BPM, Steps, Theme & Playback Loop (","type":"text"},{"text":"assets/js/main.js","type":"text","marks":[{"type":"code"}]},{"text":")","type":"text"}]},{"type":"heading","attrs":{"level":2},"content":[{"text":"Overview","type":"text"}]},{"type":"paragraph","content":[{"text":"This module drives the step sequencer’s transport and UI sync. It manages:","type":"text"}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Play/Stop control for starting and stopping playback.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"BPM and step count controls (range-clamped) for tempo and pattern length.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"The scheduling loop, which advances the sequencer and triggers sounds at audio-context time.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Real-time UI feedback (current step highlight).","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Drone playback, synchronized with transport state.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Sample file loading and decoding for custom audio playback.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Theme selection and persistence.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"State syncing with the browser URL for deep-linking and persistence.","type":"text"}]}]}]},{"type":"paragraph","content":[{"text":"Use this module to coordinate sequencer playback, handle user input, and keep the UI in sync with audio state.","type":"text"}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2},"content":[{"text":"Quick-Start","type":"text"}]},{"type":"paragraph","content":[{"text":"Get up and running locally:","type":"text"}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Open ","type":"text"},{"text":"index.html","type":"text","marks":[{"type":"code"}]},{"text":" in your browser.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Adjust BPM and steps using the sliders or input fields.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Click \"Play\" to start the sequencer; click again to stop.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Upload a sample (optional) under \"Sample File\" for custom sounds.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Add drone or beep channels to expand the sound palette.","type":"text"}]}]}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2},"content":[{"text":"Key Concepts / Responsibilities","type":"text"}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Transport Control","type":"text","marks":[{"type":"bold"}]}]}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"playToggle","type":"text","marks":[{"type":"code"}]},{"text":" starts/stops playback and toggles button text (\"Play\"/\"Stop\").","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"On start: resets ","type":"text"},{"text":"currentStep","type":"text","marks":[{"type":"code"}]},{"text":" to -1, arms drones, runs an immediate ","type":"text"},{"text":"tick()","type":"text","marks":[{"type":"code"}]},{"text":" then schedules the loop.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"On stop: clears timer and current-step indicators.","type":"text"}]}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"BPM & Steps Management","type":"text","marks":[{"type":"bold"}]}]}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"BPM and steps can be changed via inputs or sliders (","type":"text"},{"text":"bpmInput","type":"text","marks":[{"type":"code"}]},{"text":", ","type":"text"},{"text":"bpmSlider","type":"text","marks":[{"type":"code"}]},{"text":", ","type":"text"},{"text":"stepsInput","type":"text","marks":[{"type":"code"}]},{"text":", ","type":"text"},{"text":"stepsSlider","type":"text","marks":[{"type":"code"}]},{"text":").","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Values are clamped (BPM: 40–220, Steps: 4–32).","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Step duration via ","type":"text"},{"text":"stepMs()","type":"text","marks":[{"type":"code"}]},{"text":" (a 16th-note = 60000/BPM/4).","type":"text"}]}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Tick Scheduling & Playback Loop","type":"text","marks":[{"type":"bold"}]}]}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"scheduleLoop()","type":"text","marks":[{"type":"code"}]},{"text":" uses ","type":"text"},{"text":"setTimeout","type":"text","marks":[{"type":"code"}]},{"text":" to call ","type":"text"},{"text":"tick()","type":"text","marks":[{"type":"code"}]},{"text":" based on ","type":"text"},{"text":"stepMs()","type":"text","marks":[{"type":"code"}]},{"text":".","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"tick()","type":"text","marks":[{"type":"code"}]},{"text":" clears old indicators, advances ","type":"text"},{"text":"currentStep","type":"text","marks":[{"type":"code"}]},{"text":", sets new indicator, and schedules active tracks at ","type":"text"},{"text":"ctx.currentTime + 0.01","type":"text","marks":[{"type":"code"}]},{"text":".","type":"text"}]}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Current-Step Indicators","type":"text","marks":[{"type":"bold"}]}]}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Grid highlights are updated each tick via ","type":"text"},{"text":"gridApi.setCurrentIndicator(currentStep)","type":"text","marks":[{"type":"code"}]},{"text":", and cleared on stop.","type":"text"}]}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Drone Management","type":"text","marks":[{"type":"bold"}]}]}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Drones start when transport starts and stop when it stops.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Drone state is encoded/decoded with the URL.","type":"text"}]}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Sample File Support","type":"text","marks":[{"type":"bold"}]}]}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"A selected file is decoded via Web Audio (","type":"text"},{"text":"ctx.decodeAudioData","type":"text","marks":[{"type":"code"}]},{"text":") and stored as ","type":"text"},{"text":"sampleBuffer","type":"text","marks":[{"type":"code"}]},{"text":".","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Decoding success/failure is shown in ","type":"text"},{"text":"sampleStatus","type":"text","marks":[{"type":"code"}]},{"text":".","type":"text"}]}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Theme Management","type":"text","marks":[{"type":"bold"}]}]}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Theme is initialized via ","type":"text"},{"text":"setupTheme","type":"text","marks":[{"type":"code"}]},{"text":" and persisted in the URL.","type":"text"}]}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"State Sync & Deep-Linking","type":"text","marks":[{"type":"bold"}]}]}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Core parameters are encoded in the URL by ","type":"text"},{"text":"updateURL()","type":"text","marks":[{"type":"code"}]},{"text":" and loaded by ","type":"text"},{"text":"loadFromURL()","type":"text","marks":[{"type":"code"}]},{"text":". Encoded fields: BPM (","type":"text"},{"text":"b","type":"text","marks":[{"type":"code"}]},{"text":"), steps (","type":"text"},{"text":"s","type":"text","marks":[{"type":"code"}]},{"text":"), per-track sequences (","type":"text"},{"text":"p","type":"text","marks":[{"type":"code"}]},{"text":"), instruments (","type":"text"},{"text":"i","type":"text","marks":[{"type":"code"}]},{"text":"), drones (","type":"text"},{"text":"d","type":"text","marks":[{"type":"code"}]},{"text":"), theme (","type":"text"},{"text":"t","type":"text","marks":[{"type":"code"}]},{"text":").","type":"text"}]}]}]}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2},"content":[{"text":"Usage Examples","type":"text"}]},{"type":"paragraph","content":[{"text":"Start Playback","type":"text","marks":[{"type":"bold"}]}]},{"type":"codeBlock","attrs":{"language":"js"},"content":[{"text":"playToggle.click(); // Starts sequencer, updates UI, begins tick scheduling"}]},{"type":"paragraph","content":[{"text":"Set BPM","type":"text","marks":[{"type":"bold"}]}]},{"type":"codeBlock","attrs":{"language":"js"},"content":[{"text":"bpmInput.value = \"100\";\nbpmInput.dispatchEvent(new Event(\"input\")); // Updates BPM and syncs URL"}]},{"type":"paragraph","content":[{"text":"Set Step Count","type":"text","marks":[{"type":"bold"}]}]},{"type":"codeBlock","attrs":{"language":"js"},"content":[{"text":"stepsInput.value = \"24\";\nstepsInput.dispatchEvent(new Event(\"input\")); // Updates pattern length"}]},{"type":"paragraph","content":[{"text":"Main Playback Loop","type":"text","marks":[{"type":"bold"}]}]},{"type":"codeBlock","attrs":{"language":"js"},"content":[{"text":"function scheduleLoop() {\n  if (!playing) return;\n  timer = setTimeout(() => { tick(); scheduleLoop(); }, stepMs());\n}\nfunction tick() {\n  gridApi.clearCurrentIndicators();\n  currentStep = (currentStep + 1) % steps;\n  gridApi.setCurrentIndicator(currentStep);\n  const when = ctx.currentTime + 0.01;\n  tracks.forEach(t => {\n    if (sequences[t.id]?.[currentStep]) {\n      triggerTrack(t.id, when, beepInst, sampleBuffer);\n    }\n  });\n}"}]},{"type":"paragraph","content":[{"text":"Sync State with URL","type":"text","marks":[{"type":"bold"}]}]},{"type":"codeBlock","attrs":{"language":"js"},"content":[{"text":"updateURL(); // Serializes BPM, steps, sequences, instruments, drones, theme into browser URL"}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2},"content":[{"text":"Dependencies & Interactions","type":"text"}]},{"type":"paragraph","content":[{"text":"This module connects to:","type":"text"}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/lib/audio.js","type":"text","marks":[{"type":"code"}]},{"text":": Audio context, master output, track triggering.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/lib/notes.js","type":"text","marks":[{"type":"code"}]},{"text":": Drone note definitions and note utilities.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/lib/url.js","type":"text","marks":[{"type":"code"}]},{"text":": Reading/writing URL parameters for state persistence.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/lib/theme.js","type":"text","marks":[{"type":"code"}]},{"text":": Theme setup and application.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/lib/tracks.js","type":"text","marks":[{"type":"code"}]},{"text":": Track management and sequence syncing.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/ui/grid.js","type":"text","marks":[{"type":"code"}]},{"text":": Step grid UI and current step indicators.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/ui/instruments.js","type":"text","marks":[{"type":"code"}]},{"text":": Instrument management and rendering.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/ui/drones.js","type":"text","marks":[{"type":"code"}]},{"text":": Drone channel handling and playback.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"DOM elements: Controls, sliders, file input, grids, instrument lists, theme controls.","type":"text"}]}]}]},{"type":"paragraph","content":[{"text":"Idiosyncrasies","type":"text","marks":[{"type":"bold"}]}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"All state changes propagate to the URL for deep-linking.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Playback, drones, and UI indicators are tightly coupled to transport state.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"Adding/removing beep channels triggers full track/instrument/grid rebuild.","type":"text"}]}]}]},{"type":"horizontalRule"},{"type":"heading","attrs":{"level":2},"content":[{"text":"Further Reading / Related Docs","type":"text"}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/lib/audio.js","type":"text","marks":[{"type":"code"}]},{"text":" — Core audio context, track triggering.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/lib/notes.js","type":"text","marks":[{"type":"code"}]},{"text":" — Note definitions for drones and instruments.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/lib/url.js","type":"text","marks":[{"type":"code"}]},{"text":" — URL parameter encoding/decoding.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/lib/theme.js","type":"text","marks":[{"type":"code"}]},{"text":" — Theme setup and application.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/lib/tracks.js","type":"text","marks":[{"type":"code"}]},{"text":" — Track rebuilding and sequence syncing.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/ui/grid.js","type":"text","marks":[{"type":"code"}]},{"text":" — Grid API for UI step indicators.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/ui/instruments.js","type":"text","marks":[{"type":"code"}]},{"text":" — Instrument list and channel management.","type":"text"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"text":"assets/js/ui/drones.js","type":"text","marks":[{"type":"code"}]},{"text":" — Drone setup and control logic.","type":"text"}]}]}]}]}